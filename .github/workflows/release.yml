name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - runner: macos-26
            arch: arm64
          - runner: macos-26
            arch: x86_64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Verify Sparkle keypair matches app public key
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          chmod +x scripts/verify-sparkle-keypair.sh
          ./scripts/verify-sparkle-keypair.sh

      - name: Build DMG
        env:
          CI: "true"
        run: |
          chmod +x build-dmg.sh
          ./build-dmg.sh "${{ steps.version.outputs.version }}" "${{ matrix.arch }}"

      - name: Download Sparkle CLI tools
        run: |
          curl -sL "https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz" -o /tmp/Sparkle.tar.xz
          mkdir -p /tmp/Sparkle
          tar -xf /tmp/Sparkle.tar.xz -C /tmp/Sparkle

      - name: Sign DMG with Sparkle EdDSA
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          DMG_PATH=".build/Humlex-${{ steps.version.outputs.version }}-${{ matrix.arch }}.dmg"
          SIGN_TOOL="/tmp/Sparkle/bin/sign_update"

          # Sign the DMG and capture the signature output
          SIGN_OUTPUT=$(echo "$SPARKLE_PRIVATE_KEY" | "$SIGN_TOOL" "$DMG_PATH" -f -)
          echo "Signature output: $SIGN_OUTPUT"

          # Parse edSignature from sign_update output and fail hard if missing
          ED_SIGNATURE=$(SIGN_OUTPUT="$SIGN_OUTPUT" python3 -c 'import os, re; m = re.search(r"sparkle:edSignature=\"([^\"]+)\"", os.environ.get("SIGN_OUTPUT", "")); print(m.group(1) if m else "")')

          if [ -z "$ED_SIGNATURE" ]; then
            echo "Failed to capture Sparkle signature" >&2
            exit 1
          fi

          FILE_LENGTH=$(wc -c < "$DMG_PATH" | tr -d ' ')

          if [ -z "$FILE_LENGTH" ]; then
            echo "Failed to capture DMG file length" >&2
            exit 1
          fi

          echo "ed_signature=$ED_SIGNATURE" >> "$GITHUB_OUTPUT"
          echo "file_length=$FILE_LENGTH" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Humlex-${{ steps.version.outputs.version }}-${{ matrix.arch }}
          path: .build/Humlex-${{ steps.version.outputs.version }}-${{ matrix.arch }}.dmg

      - name: Save signature info
        run: |
          mkdir -p .build/signatures
          echo '${{ steps.sign.outputs.ed_signature }}' > .build/signatures/${{ matrix.arch }}-signature.txt
          echo '${{ steps.sign.outputs.file_length }}' > .build/signatures/${{ matrix.arch }}-length.txt

      - name: Upload signature info
        uses: actions/upload-artifact@v4
        with:
          name: signature-${{ matrix.arch }}
          path: .build/signatures/

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Read signatures
        id: sigs
        run: |
          ARM64_SIG=$(cat artifacts/signature-arm64/arm64-signature.txt)
          ARM64_LEN=$(cat artifacts/signature-arm64/arm64-length.txt)
          X86_SIG=$(cat artifacts/signature-x86_64/x86_64-signature.txt)
          X86_LEN=$(cat artifacts/signature-x86_64/x86_64-length.txt)

          echo "arm64_sig=$ARM64_SIG" >> "$GITHUB_OUTPUT"
          echo "arm64_len=$ARM64_LEN" >> "$GITHUB_OUTPUT"
          echo "x86_sig=$X86_SIG" >> "$GITHUB_OUTPUT"
          echo "x86_len=$X86_LEN" >> "$GITHUB_OUTPUT"

      - name: Generate appcast.xml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${GITHUB_REF_NAME}"
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")
          REPO_URL="https://github.com/lassejlv/humlex"

          # shellcheck disable=SC1091
          source config/updater.conf
          FEED_URL="${SU_FEED_URL}"

          mkdir -p docs

          python3 -c "
          version = '${VERSION}'
          tag = '${TAG}'
          date = '${DATE}'
          repo = '${REPO_URL}'
          feed_url = '${FEED_URL}'
          arm64_sig = '${{ steps.sigs.outputs.arm64_sig }}'
          arm64_len = '${{ steps.sigs.outputs.arm64_len }}'
          x86_sig = '${{ steps.sigs.outputs.x86_sig }}'
          x86_len = '${{ steps.sigs.outputs.x86_len }}'

          xml = '''<?xml version=\"1.0\" encoding=\"utf-8\"?>
          <rss version=\"2.0\" xmlns:sparkle=\"http://www.andymatuschak.org/xml-namespaces/sparkle\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\">
            <channel>
              <title>Humlex Updates</title>
              <link>{feed_url}</link>
              <description>Most recent updates to Humlex</description>
              <language>en</language>
              <item>
                <title>Version {version} (Apple Silicon)</title>
                <pubDate>{date}</pubDate>
                <sparkle:version>{version}</sparkle:version>
                <sparkle:shortVersionString>{version}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                <enclosure
                  url=\"{repo}/releases/download/{tag}/Humlex-{version}-arm64.dmg\"
                  sparkle:edSignature=\"{arm64_sig}\"
                  length=\"{arm64_len}\"
                  type=\"application/octet-stream\"
                  sparkle:os=\"macos\"
                />
              </item>
              <item>
                <title>Version {version} (Intel)</title>
                <pubDate>{date}</pubDate>
                <sparkle:version>{version}</sparkle:version>
                <sparkle:shortVersionString>{version}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                <enclosure
                  url=\"{repo}/releases/download/{tag}/Humlex-{version}-x86_64.dmg\"
                  sparkle:edSignature=\"{x86_sig}\"
                  length=\"{x86_len}\"
                  type=\"application/octet-stream\"
                  sparkle:os=\"macos\"
                />
              </item>
            </channel>
          </rss>'''

          import textwrap
          xml = textwrap.dedent(xml).strip()
          xml = xml.format(
              version=version, tag=tag, date=date, repo=repo, feed_url=feed_url,
              arm64_sig=arm64_sig, arm64_len=arm64_len,
              x86_sig=x86_sig, x86_len=x86_len
          )
          with open('docs/appcast.xml', 'w') as f:
              f.write(xml + '\n')
          print(xml)
          "

      - name: Verify generated appcast metadata
        run: |
          python3 - <<'PY'
          import xml.etree.ElementTree as ET

          ns = {"sparkle": "http://www.andymatuschak.org/xml-namespaces/sparkle"}
          tree = ET.parse("docs/appcast.xml")
          channel = tree.getroot().find("channel")
          if channel is None:
              raise SystemExit("appcast.xml missing <channel>")

          items = channel.findall("item")
          if len(items) != 2:
              raise SystemExit(f"Expected 2 appcast items, found {len(items)}")

          expected = {
              "arm64": {
                  "url_suffix": "-arm64.dmg",
                  "sig": "${{ steps.sigs.outputs.arm64_sig }}",
                  "len": "${{ steps.sigs.outputs.arm64_len }}",
              },
              "x86_64": {
                  "url_suffix": "-x86_64.dmg",
                  "sig": "${{ steps.sigs.outputs.x86_sig }}",
                  "len": "${{ steps.sigs.outputs.x86_len }}",
              },
          }

          for item in items:
              enclosure = item.find("enclosure")
              if enclosure is None:
                  raise SystemExit("Found appcast item without enclosure")

              url = enclosure.attrib.get("url", "")
              sig = enclosure.attrib.get(f"{{{ns['sparkle']}}}edSignature", "")
              length = enclosure.attrib.get("length", "")

              matched_arch = None
              for arch, values in expected.items():
                  if url.endswith(values["url_suffix"]):
                      matched_arch = arch
                      break

              if matched_arch is None:
                  raise SystemExit(f"Unexpected enclosure URL in appcast: {url}")

              values = expected[matched_arch]
              if sig != values["sig"]:
                  raise SystemExit(f"Signature mismatch for {matched_arch}")
              if length != values["len"]:
                  raise SystemExit(f"Length mismatch for {matched_arch}")

          print("Appcast signature metadata verified.")
          PY

      - name: Commit updated appcast.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/appcast.xml
          git commit -m "Update appcast.xml for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/**/*.dmg
